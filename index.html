<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>DJANGOæ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans JP', 'Hiragino Sans', sans-serif; background: #f8f7f4; color: #1a1a1a; min-height: 100vh; }

  .header { background: #1c1917; padding: 0 16px; height: 52px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
  .header-title { color: #fff; font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .mode-switcher { background: #292524; border-radius: 8px; padding: 4px; display: flex; gap: 4px; }
  .mode-btn { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; font-family: inherit; transition: all 0.15s; }
  .mode-btn.active { background: #f59e0b; color: #1c1917; }
  .mode-btn.inactive { background: transparent; color: #a8a29e; }

  .main { max-width: 700px; margin: 0 auto; padding: 16px; }

  .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
  .stat-card { background: #fff; border-radius: 10px; padding: 12px 14px; border: 1px solid #e7e5e4; }
  .stat-label { font-size: 11px; color: #78716c; margin-bottom: 2px; }
  .stat-value { font-size: 26px; font-weight: 700; }

  .btn { padding: 10px 18px; border-radius: 8px; border: none; font-weight: 700; font-size: 14px; cursor: pointer; font-family: inherit; }
  .btn-primary { background: #f59e0b; color: #1c1917; }
  .btn-secondary { background: #fff; color: #1c1917; border: 1px solid #d6d3d1; font-weight: 600; }
  .btn-dark { background: #1c1917; color: #fff; }
  .btn-danger { background: #fee2e2; color: #dc2626; padding: 6px 12px; font-size: 12px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; }
  .btn-green { background: #10b981; color: #fff; padding: 8px 14px; font-size: 13px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; }
  .btn-purple { background: #6366f1; color: #fff; padding: 8px 14px; font-size: 13px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; }

  .action-bar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; align-items: center; }
  .sync-status { font-size: 12px; color: #10b981; margin-left: auto; display: flex; align-items: center; gap: 4px; }
  .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: #10b981; }

  .filters { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
  .filter-btn { padding: 5px 12px; border-radius: 20px; border: 1px solid #d6d3d1; cursor: pointer; font-size: 12px; font-family: inherit; background: #fff; color: #78716c; }
  .filter-btn.active { background: #1c1917; color: #fff; border-color: #1c1917; font-weight: 700; }

  .form-card { background: #fff; border-radius: 12px; border: 1px solid #e7e5e4; padding: 16px; margin-bottom: 14px; }
  .form-title { font-weight: 700; font-size: 15px; margin-bottom: 14px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .form-group label { font-size: 12px; color: #78716c; display: block; margin-bottom: 4px; }
  .form-group input, .form-group textarea { width: 100%; padding: 9px 12px; border: 1px solid #d6d3d1; border-radius: 6px; font-size: 14px; font-family: inherit; outline: none; -webkit-appearance: none; }
  .form-group input:focus, .form-group textarea:focus { border-color: #f59e0b; }
  .form-actions { display: flex; gap: 8px; margin-top: 14px; }

  .order-list { display: flex; flex-direction: column; gap: 8px; }
  .order-card { background: #fff; border-radius: 12px; border: 1px solid #e7e5e4; padding: 14px 16px; border-left: 4px solid; }
  .order-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
  .order-info { flex: 1; }
  .order-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
  .order-model { font-size: 12px; color: #78716c; background: #f5f5f4; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-left: 6px; }
  .badge { font-size: 12px; padding: 3px 10px; border-radius: 20px; font-weight: 600; display: inline-block; margin-top: 4px; }
  .order-meta { margin-top: 6px; font-size: 13px; color: #57534e; display: flex; gap: 12px; flex-wrap: wrap; }
  .order-memo { margin-top: 6px; font-size: 13px; color: #78716c; background: #fafaf9; padding: 4px 10px; border-radius: 4px; }
  .order-time { font-size: 11px; color: #a8a29e; margin-top: 4px; }
  .order-actions { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; flex-shrink: 0; }

  .empty { text-align: center; padding: 60px 20px; color: #a8a29e; background: #fff; border-radius: 12px; border: 1px solid #e7e5e4; }
  .empty-icon { font-size: 40px; margin-bottom: 8px; }

  .loading { text-align: center; padding: 60px 20px; color: #a8a29e; }
  .spinner { width: 32px; height: 32px; border: 3px solid #e7e5e4; border-top-color: #f59e0b; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; z-index: 100; }
  .modal-overlay.center { align-items: center; padding: 16px; }
  .modal { background: #fff; border-radius: 16px 16px 0 0; width: 100%; max-height: 85vh; overflow-y: auto; padding: 20px; }
  .modal.center { border-radius: 16px; max-width: 540px; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .modal-title { font-weight: 700; font-size: 17px; }
  .modal-close { background: none; border: none; font-size: 22px; cursor: pointer; color: #78716c; padding: 0 4px; }

  .week-select { width: 100%; padding: 9px 12px; border: 1px solid #d6d3d1; border-radius: 6px; font-size: 14px; font-family: inherit; margin-bottom: 14px; }
  .weekly-preview { background: #fafaf9; border-radius: 8px; padding: 14px; font-family: monospace; font-size: 12px; white-space: pre-wrap; margin-bottom: 14px; border: 1px solid #e7e5e4; line-height: 1.8; max-height: 40vh; overflow-y: auto; }
  .modal-actions { display: flex; gap: 10px; }
  .modal-actions .btn { flex: 1; text-align: center; }

  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1c1917; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; z-index: 200; opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; }
  .toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="header">
  <div class="header-title">
    <div class="dot"></div>DJANGOæ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
  </div>
  <div class="mode-switcher">
    <button class="mode-btn active" id="btn-store" onclick="setMode('store')">åº—èˆ—ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="mode-btn inactive" id="btn-wholesaler" onclick="setMode('wholesaler')">å•å±‹ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
</div>

<div class="main">
  <div class="stats">
    <div class="stat-card"><div class="stat-label">å…¨æ³¨æ–‡</div><div class="stat-value" id="stat-total" style="color:#1c1917">-</div></div>
    <div class="stat-card"><div class="stat-label">æœªç¢ºèª</div><div class="stat-value" id="stat-pending" style="color:#f59e0b">-</div></div>
    <div class="stat-card"><div class="stat-label">æŠ¼ã•ãˆæ¸ˆã¿</div><div class="stat-value" id="stat-reserved" style="color:#10b981">-</div></div>
  </div>

  <div class="action-bar">
    <button class="btn btn-primary" id="add-btn" onclick="toggleForm()">ï¼‹ æ³¨æ–‡ã‚’è¿½åŠ </button>
    <button class="btn btn-secondary" onclick="openWeekly()">ğŸ“‹ é€±æ¬¡ãƒªã‚¹ãƒˆ</button>
    <div class="sync-status" id="sync-status"><div class="sync-dot"></div>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­</div>
  </div>

  <div class="filters">
    <button class="filter-btn active" onclick="setFilter('all', this)">ã™ã¹ã¦</button>
    <button class="filter-btn" onclick="setFilter('pending', this)">æœªç¢ºèª</button>
    <button class="filter-btn" onclick="setFilter('reserved', this)">æŠ¼ã•ãˆæ¸ˆã¿</button>
    <button class="filter-btn" onclick="setFilter('ordered', this)">æ³¨æ–‡æ¸ˆã¿</button>
  </div>

  <div class="form-card" id="order-form" style="display:none">
    <div class="form-title">æ–°è¦æ³¨æ–‡ç™»éŒ²</div>
    <div class="form-grid">
      <div class="form-group">
        <label>å•†å“å ï¼Š</label>
        <input type="text" id="f-product" placeholder="ä¾‹ï¼šãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«">
      </div>
      <div class="form-group">
        <label>ã‚«ãƒ©ãƒ¼</label>
        <input type="text" id="f-model" placeholder="ä¾‹ï¼šDT-001">
      </div>
      <div class="form-group">
        <label>æ•°é‡ ï¼Š</label>
        <input type="text" id="f-qty" placeholder="ä¾‹ï¼š2">
      </div>
      <div class="form-group">
        <label>ãŠå®¢æ§˜ç•ªå· ï¼Š</label>
        <input type="text" id="f-customer" placeholder="ä¾‹ï¼šå±±ç”°æ§˜">
      </div>
      <div class="form-group" style="grid-column: span 2">
        <label>å‚™è€ƒ</label>
        <input type="text" id="f-memo" placeholder="ç´æœŸæŒ‡å®šãªã©">
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-dark" onclick="addOrder()">ç™»éŒ²ã™ã‚‹</button>
      <button class="btn btn-secondary" onclick="toggleForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div id="order-list">
    <div class="loading"><div class="spinner"></div>æ¥ç¶šä¸­...</div>
  </div>
</div>

<!-- Weekly modal -->
<div class="modal-overlay center" id="weekly-modal" style="display:none" onclick="closeWeeklyOutside(event)">
  <div class="modal center">
    <div class="modal-header">
      <div class="modal-title">ğŸ“‹ é€±æ¬¡æ³¨æ–‡ãƒªã‚¹ãƒˆ</div>
      <button class="modal-close" onclick="closeWeekly()">âœ•</button>
    </div>
    <label style="font-size:12px;color:#78716c;display:block;margin-bottom:6px">å¯¾è±¡é€±ã‚’é¸æŠ</label>
    <select class="week-select" id="week-select" onchange="updatePreview()"></select>
    <div class="weekly-preview" id="weekly-preview">é€±ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div class="modal-actions">
      <button class="btn btn-dark" id="copy-btn" onclick="copyText()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDx6oJnre3L1UWcYzeKFzPjaLo5_E5qZLc",
    authDomain: "django-interior.firebaseapp.com",
    databaseURL: "https://django-interior-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "django-interior",
    storageBucket: "django-interior.firebasestorage.app",
    messagingSenderId: "600675642337",
    appId: "1:600675642337:web:2e420e6553093600f200a0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const ordersRef = ref(db, 'orders');

  const STATUS = {
    pending:  { label: 'æœªç¢ºèª',    color: '#f59e0b', bg: '#fef3c7' },
    reserved: { label: 'æŠ¼ã•ãˆæ¸ˆã¿', color: '#10b981', bg: '#d1fae5' },
    ordered:  { label: 'æ³¨æ–‡æ¸ˆã¿',  color: '#6366f1', bg: '#e0e7ff' },
  };

  let mode = 'store';
  let orders = {};
  let filterStatus = 'all';
  let formOpen = false;

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
  onValue(ordersRef, (snapshot) => {
    orders = snapshot.val() || {};
    render();
    document.getElementById('sync-status').innerHTML = '<div class="sync-dot"></div>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­';
  }, (error) => {
    document.getElementById('sync-status').innerHTML = '<span style="color:#ef4444">âš  æ¥ç¶šã‚¨ãƒ©ãƒ¼</span>';
  });

  window.setMode = function(m) {
    mode = m;
    document.getElementById('btn-store').className = 'mode-btn ' + (m === 'store' ? 'active' : 'inactive');
    document.getElementById('btn-wholesaler').className = 'mode-btn ' + (m === 'wholesaler' ? 'active' : 'inactive');
    document.getElementById('add-btn').style.display = m === 'store' ? '' : 'none';
    if (formOpen && m !== 'store') window.toggleForm();
    render();
  };

  window.setFilter = function(s, btn) {
    filterStatus = s;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    render();
  };

  window.toggleForm = function() {
    formOpen = !formOpen;
    document.getElementById('order-form').style.display = formOpen ? '' : 'none';
    if (!formOpen) clearForm();
  };

  function clearForm() {
    ['f-product','f-model','f-qty','f-customer','f-memo'].forEach(id => document.getElementById(id).value = '');
  }

  window.addOrder = async function() {
    const product  = document.getElementById('f-product').value.trim();
    const model    = document.getElementById('f-model').value.trim();
    const qty      = document.getElementById('f-qty').value.trim();
    const customer = document.getElementById('f-customer').value.trim();
    const memo     = document.getElementById('f-memo').value.trim();
    if (!product || !qty || !customer) { showToast('âš  å•†å“åãƒ»æ•°é‡ãƒ»ãŠå®¢æ§˜ç•ªå·ã¯å¿…é ˆã§ã™'); return; }
    await push(ordersRef, {
      productName: product,
      modelNumber: model,
      quantity: qty,
      customerName: customer,
      memo,
      status: 'pending',
      createdAt: new Date().toISOString()
    });
    showToast('âœ“ æ³¨æ–‡ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
    window.toggleForm();
  };

  window.updateStatus = async function(id, status) {
    await update(ref(db, 'orders/' + id), { status });
    const label = STATUS[status]?.label || status;
    showToast(`âœ“ ã€Œ${label}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`);
  };

  window.deleteOrder = async function(id) {
    if (!confirm('ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    await remove(ref(db, 'orders/' + id));
    showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
  };

  function fmtDT(iso) {
    const d = new Date(iso);
    return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }

  function render() {
    const arr = Object.entries(orders).map(([id, o]) => ({ id, ...o }))
      .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

    document.getElementById('stat-total').textContent   = arr.length;
    document.getElementById('stat-pending').textContent  = arr.filter(o => o.status === 'pending').length;
    document.getElementById('stat-reserved').textContent = arr.filter(o => o.status === 'reserved').length;

    const filtered = filterStatus === 'all' ? arr : arr.filter(o => o.status === filterStatus);
    const list = document.getElementById('order-list');

    if (filtered.length === 0) {
      list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“¦</div><div>æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
      return;
    }

    list.innerHTML = filtered.map(o => {
      const s = STATUS[o.status];
      let actionBtns = '';
      if (mode === 'wholesaler' && o.status === 'pending')
        actionBtns = `<button class="btn-green" onclick="updateStatus('${o.id}','reserved')">æŠ¼ã•ãˆæ¸ˆã¿ã«ã™ã‚‹</button>`;
      else if (mode === 'wholesaler' && o.status === 'reserved')
        actionBtns = `<span style="font-size:11px;color:#10b981">âœ“ å¯¾å¿œæ¸ˆã¿</span>`;
      else if (mode === 'store' && o.status === 'reserved')
        actionBtns = `<button class="btn-purple" onclick="updateStatus('${o.id}','ordered')">æ³¨æ–‡æ¸ˆã¿ã«ã™ã‚‹</button>`;

      const deleteBtn = mode === 'store'
        ? `<button class="btn-danger" onclick="deleteOrder('${o.id}')">å‰Šé™¤</button>` : '';

      return `
        <div class="order-card" style="border-left-color:${s.color}">
          <div class="order-top">
            <div class="order-info">
              <div class="order-name">${esc(o.productName)}${o.modelNumber ? `<span class="order-model">${esc(o.modelNumber)}</span>` : ''}</div>
              <span class="badge" style="background:${s.bg};color:${s.color}">${s.label}</span>
              <div class="order-meta">
                <span>æ•°é‡: <strong>${esc(o.quantity)}</strong></span>
                <span>ãŠå®¢æ§˜: <strong>${esc(o.customerName)}</strong></span>
              </div>
              ${o.memo ? `<div class="order-memo">å‚™è€ƒ: ${esc(o.memo)}</div>` : ''}
              <div class="order-time">ç™»éŒ²: ${fmtDT(o.createdAt)}</div>
            </div>
            <div class="order-actions">
              ${actionBtns}
              ${deleteBtn}
            </div>
          </div>
        </div>`;
    }).join('');
  }

  function esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // Weekly
  function getWeekKey(iso) {
    const d = new Date(iso);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(new Date(iso).setDate(diff)).toISOString().slice(0,10);
  }
  function getWeekLabel(wk) {
    const d = new Date(wk);
    const end = new Date(d); end.setDate(d.getDate() + 6);
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    return `${d.getMonth()+1}/${d.getDate()}ï¼ˆ${days[d.getDay()]}ï¼‰ã€œ ${end.getMonth()+1}/${end.getDate()}ï¼ˆ${days[end.getDay()]}ï¼‰`;
  }

  window.openWeekly = function() {
    const arr = Object.values(orders);
    const weeks = [...new Set(arr.map(o => getWeekKey(o.createdAt)))].sort().reverse();
    if (weeks.length === 0) weeks.push(getWeekKey(new Date().toISOString()));
    const sel = document.getElementById('week-select');
    sel.innerHTML = weeks.map(w => `<option value="${w}">${getWeekLabel(w)}</option>`).join('');
    window.updatePreview();
    document.getElementById('weekly-modal').style.display = '';
  };

  window.closeWeekly = function() { document.getElementById('weekly-modal').style.display = 'none'; };
  window.closeWeeklyOutside = function(e) { if (e.target.id === 'weekly-modal') window.closeWeekly(); };

  window.updatePreview = function() {
    const wk = document.getElementById('week-select').value;
    document.getElementById('weekly-preview').textContent = wk ? generateText(wk) : 'é€±ã‚’é¸æŠã—ã¦ãã ã•ã„';
  };

  function generateText(wk) {
    const arr = Object.values(orders).filter(o => getWeekKey(o.createdAt) === wk)
      .sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
    const now = new Date();
    const lines = [
      `ã€é€±æ¬¡æ³¨æ–‡ãƒªã‚¹ãƒˆã€‘`,
      `å¯¾è±¡æœŸé–“: ${getWeekLabel(wk)}`,
      `ä½œæˆæ—¥æ™‚: ${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`,
      'â”€'.repeat(36), ''
    ];
    arr.forEach((o, i) => {
      lines.push(`${i+1}. ${o.productName}${o.modelNumber ? `ï¼ˆ${o.modelNumber}ï¼‰` : ''}`);
      lines.push(`   æ•°é‡: ${o.quantity}ã€€ãŠå®¢æ§˜: ${o.customerName}`);
      if (o.memo) lines.push(`   å‚™è€ƒ: ${o.memo}`);
      lines.push(`   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${STATUS[o.status]?.label || o.status}`);
      lines.push('');
    });
    lines.push('â”€'.repeat(36));
    lines.push(`åˆè¨ˆ ${arr.length} ä»¶`);
    return lines.join('\n');
  }

  window.copyText = function() {
    const wk = document.getElementById('week-select').value;
    if (!wk) return;
    const text = generateText(wk);
    navigator.clipboard.writeText(text).catch(() => {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta); ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }).finally ? null : null;
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
    setTimeout(() => btn.textContent = 'ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼', 2000);
    showToast('âœ“ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  };

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  // åˆæœŸè¡¨ç¤º
  window.setMode('store');
</script>
</body>
</html>
